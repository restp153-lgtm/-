---
title: "NBA機器學習方法比較"
format: html
editor: visual
---

## Data Clean

```{r}
#| echo: true
setwd("C:/Users/jef81/Desktop/計算生物學/NBA")
GameLogs <- read.csv("NBA_GameLogs_202425.csv")
PlayerStats <- read.csv("NBA_PlayerStats_202425.csv")
TeamInfo <- read.csv("NBA_TeamInfo_202425.csv")
TeamStats <- read.csv("NBA_TeamStats_202425.csv")

NBA_Stats <- TeamStats[TeamStats$TEAM_ID %in% TeamInfo$TEAM_ID,]
ml_data <- subset(NBA_Stats, select = c("TEAM_ID", "TEAM_NAME", "PTS", "REB",
                                   "AST", "BLK", "STL", "TOV", "FG3_PCT", 
                                   "FG_PCT", "OFF_RATING", "DEF_RATING",
                                   "NET_RATING"))
```

載入需要的套件（如未安裝需先安裝）

```{r}
#| echo: true
#| warning: false
library(dplyr)
library(tidyr)
library(ggplot2)
```

Step 1. 先把 TeamInfo 的 ABBREVIATION 加進 ml_data

```{r}
#| echo: true
#| message: false
#| warning: false
ml_data2 <- ml_data %>%
  left_join(TeamInfo %>% select(TEAM_ID, ABBREVIATION),
            by = "TEAM_ID")
```

Step 2. 從 PlayerStats 取出需要的欄位

```{r}
#| echo: true
#| warning: false
player_data <- PlayerStats %>%
  select(PLAYER_NAME, TEAM_ABBREVIATION, MIN_base,
         PLUS_MINUS, NBA_FANTASY_PTS)
```

Step 3. 每隊選上場時間前 8 名

```{r}
#| echo: true
#| warning: false
top8_players <- player_data %>%
  group_by(TEAM_ABBREVIATION) %>%
  arrange(desc(MIN_base)) %>%
  slice_head(n = 8) %>%
  mutate(rank = row_number()) %>%
  ungroup()
```

Step 4. 寬格式 pivot_wider

```{r}
#| echo: true
#| warning: false
top8_wide <- top8_players %>%
  select(TEAM_ABBREVIATION, rank,
         PLAYER_NAME, PLUS_MINUS, NBA_FANTASY_PTS) %>%
  pivot_wider(
    names_from = rank,
    values_from = c(PLAYER_NAME, PLUS_MINUS, NBA_FANTASY_PTS),
    names_glue = "player{rank}_{.value}"
  )

names(top8_wide) <- gsub("PLAYER_NAME", "player", names(top8_wide))
names(top8_wide) <- gsub("PLUS_MINUS", "pm", names(top8_wide))
names(top8_wide) <- gsub("NBA_FANTASY_PTS", "fantasy_pts", names(top8_wide))
```

Step 5. 用 ABBREVIATION 合併進 ml_data2，製作出ml_data_final

```{r}
#| warning: false
ml_data_final <- ml_data2 %>%
  left_join(top8_wide,
            by = c("ABBREVIATION" = "TEAM_ABBREVIATION"))
# 把 ABBREVIATION 加入最終資料
ml_data_final <- ml_data_final %>%
  mutate(ABBREVIATION = ABBREVIATION)

# 如果 MATCHUP 包含 "@", 代表客場
GameLogs2 <- GameLogs %>%
  mutate(
    Home = ifelse(grepl("@", MATCHUP), 0, 1),
    WL_num = ifelse(WL == "W", 1, 0)
  )

# 先選 ml_data_final 需要的欄位
team_vars <- ml_data_final

# --- Step 1. 解析主客場與勝負 ---
GameLogs2 <- GameLogs %>%
  select(TEAM_ABBREVIATION, MATCHUP, WL) %>%  # 只保留合併用欄位
  mutate(
    Home = ifelse(grepl("@", MATCHUP), 0, 1),
    WL_num = ifelse(WL == "W", 1, 0)
  )

# --- Step 2. 合併 ml_data_final ---
GameLogs2 <- GameLogs2 %>%
  left_join(ml_data_final, by = c("TEAM_ABBREVIATION" = "ABBREVIATION"))
```
